//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/Zetzsche/Development/SimarisCurves/com.thoughtworks.xstream/src/com/thoughtworks/xstream/core/util/DependencyInjectionFactory.java
//

#line 1 "/Users/Zetzsche/Development/SimarisCurves/com.thoughtworks.xstream/src/com/thoughtworks/xstream/core/util/DependencyInjectionFactory.java"

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "com/thoughtworks/xstream/converters/reflection/ObjectAccessException.h"
#include "com/thoughtworks/xstream/core/util/DependencyInjectionFactory.h"
#include "com/thoughtworks/xstream/core/util/Primitives.h"
#include "com/thoughtworks/xstream/core/util/TypedNull.h"
#include "java/lang/ExceptionInInitializerError.h"
#include "java/lang/IllegalAccessException.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/InstantiationException.h"
#include "java/lang/Integer.h"
#include "java/lang/SecurityException.h"
#include "java/lang/System.h"
#include "java/lang/reflect/Constructor.h"
#include "java/lang/reflect/InvocationTargetException.h"
#include "java/util/ArrayList.h"
#include "java/util/Arrays.h"
#include "java/util/BitSet.h"
#include "java/util/List.h"


#line 30
@implementation ComThoughtworksXstreamCoreUtilDependencyInjectionFactory


#line 46
+ (id)newInstanceWithIOSClass:(IOSClass *)type
            withNSObjectArray:(IOSObjectArray *)dependencies {
  
#line 47
  return [ComThoughtworksXstreamCoreUtilDependencyInjectionFactory newInstanceWithIOSClass:type withNSObjectArray:dependencies withJavaUtilBitSet:nil];
}


#line 65
+ (id)newInstanceWithIOSClass:(IOSClass *)type
            withNSObjectArray:(IOSObjectArray *)dependencies
           withJavaUtilBitSet:(JavaUtilBitSet *)usedDependencies {
  
#line 66
  if (dependencies != nil && dependencies->size_ > 63) {
    @throw [[JavaLangIllegalArgumentException alloc] initWithNSString:@"More than 63 arguments are not supported"];
  }
  JavaLangReflectConstructor *bestMatchingCtor = nil;
  JavaUtilArrayList *matchingDependencies = [[JavaUtilArrayList alloc] init];
  id<JavaUtilList> possibleMatchingDependencies = nil;
  jlong usedDeps = 0;
  jlong possibleUsedDeps = 0;
  
#line 75
  if (dependencies != nil && dependencies->size_ > 0) {
    
#line 77
    IOSObjectArray *ctors = [((IOSClass *) nil_chk(type)) getConstructors];
    if (((IOSObjectArray *) nil_chk(ctors))->size_ > 1) {
      [JavaUtilArrays sortWithNSObjectArray:ctors withJavaUtilComparator:[[ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_$1 alloc] init]];
    }
    
#line 87
    IOSObjectArray *typedDependencies = [IOSObjectArray arrayWithLength:dependencies->size_ type:[IOSClass classWithClass:[ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue class]]];
    for (jint i = 0; i < dependencies->size_; i++) {
      id dependency = IOSObjectArray_Get(dependencies, i);
      IOSClass *depType = [nil_chk(dependency) getClass];
      if ([depType isPrimitive]) {
        depType = [ComThoughtworksXstreamCoreUtilPrimitives boxWithIOSClass:depType];
      }
      else
#line 93
      if (depType == [IOSClass classWithClass:[ComThoughtworksXstreamCoreUtilTypedNull class]]) {
        depType = [((ComThoughtworksXstreamCoreUtilTypedNull *) check_class_cast(dependency, [ComThoughtworksXstreamCoreUtilTypedNull class])) getType];
        dependency = nil;
      }
      
#line 98
      IOSObjectArray_SetAndConsume(typedDependencies, i, [[ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue alloc] initWithIOSClass:depType withId:dependency]);
    }
    
#line 101
    JavaLangReflectConstructor *possibleCtor = nil;
    jint arity = JavaLangInteger_MAX_VALUE;
    for (jint i = 0; bestMatchingCtor == nil && i < ctors->size_; i++) {
      JavaLangReflectConstructor *constructor = IOSObjectArray_Get(ctors, i);
      IOSObjectArray *parameterTypes = [((JavaLangReflectConstructor *) nil_chk(constructor)) getParameterTypes];
      if (((IOSObjectArray *) nil_chk(parameterTypes))->size_ > dependencies->size_) {
        continue;
      }
      else
#line 108
      if (parameterTypes->size_ == 0) {
        if (possibleCtor == nil) {
          bestMatchingCtor = constructor;
        }
        break;
      }
      if (arity > parameterTypes->size_) {
        if (possibleCtor != nil) {
          continue;
        }
        arity = parameterTypes->size_;
      }
      
#line 121
      for (jint j = 0; j < parameterTypes->size_; j++) {
        if ([((IOSClass *) nil_chk(IOSObjectArray_Get(parameterTypes, j))) isPrimitive]) {
          IOSObjectArray_Set(parameterTypes, j, [ComThoughtworksXstreamCoreUtilPrimitives boxWithIOSClass:IOSObjectArray_Get(parameterTypes, j)]);
        }
      }
      
#line 129
      [matchingDependencies clear];
      usedDeps = 0;
      for (jint j = 0, k = 0; j < parameterTypes->size_ &&
#line 132
      parameterTypes->size_ + k - j <= typedDependencies->size_; k++) {
        if ([((IOSClass *) nil_chk(IOSObjectArray_Get(parameterTypes, j))) isAssignableFrom:((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(typedDependencies, k)))->type_]) {
          [matchingDependencies addWithId:((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(typedDependencies, k)))->value_];
          usedDeps |= LShift64(1LL, k);
          if (++j == parameterTypes->size_) {
            bestMatchingCtor = constructor;
            break;
          }
        }
      }
      
#line 143
      if (bestMatchingCtor == nil) {
        jboolean possible = YES;
        
#line 148
        IOSObjectArray *deps = [IOSObjectArray arrayWithLength:typedDependencies->size_ type:[IOSClass classWithClass:[ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue class]]];
        [JavaLangSystem arraycopyWithId:typedDependencies withInt:0 withId:deps withInt:0 withInt:deps->size_];
        [matchingDependencies clear];
        usedDeps = 0;
        for (jint j = 0; j < parameterTypes->size_; j++) {
          jint assignable = -1;
          for (jint k = 0; k < deps->size_; k++) {
            if (IOSObjectArray_Get(deps, k) == nil) {
              continue;
            }
            if (((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, k)))->type_ == IOSObjectArray_Get(parameterTypes, j)) {
              assignable = k;
              
#line 161
              break;
            }
            else
#line 162
            if ([((IOSClass *) nil_chk(IOSObjectArray_Get(parameterTypes, j))) isAssignableFrom:((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, k)))->type_]) {
              
#line 164
              if (assignable < 0 ||
#line 165
              (((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, assignable)))->type_ != ((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, k)))->type_ && [((IOSClass *) nil_chk(((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, assignable)))->type_)) isAssignableFrom:
#line 166
              ((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, k)))->type_])) {
                assignable = k;
              }
            }
          }
          
#line 172
          if (assignable >= 0) {
            [matchingDependencies addWithId:((ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *) nil_chk(IOSObjectArray_Get(deps, assignable)))->value_];
            usedDeps |= LShift64(1LL, assignable);
            IOSObjectArray_Set(deps, assignable, nil);
          }
          else {
            
#line 177
            possible = NO;
            break;
          }
        }
        
#line 182
        if (possible) {
          
#line 184
          if (possibleCtor != nil && usedDeps >= possibleUsedDeps) {
            continue;
          }
          possibleCtor = constructor;
          possibleMatchingDependencies = (id<JavaUtilList>) check_protocol_cast([matchingDependencies clone], @protocol(JavaUtilList));
          possibleUsedDeps = usedDeps;
        }
      }
    }
    
#line 194
    if (bestMatchingCtor == nil) {
      if (possibleCtor == nil) {
        usedDeps = 0;
        @throw [[ComThoughtworksXstreamConvertersReflectionObjectAccessException alloc] initWithNSString:JreStrcat("$$$", @"Cannot construct ",
#line 198
        [type getName], @", none of the dependencies match any constructor's parameters")];
      }
      else {
        bestMatchingCtor = possibleCtor;
        [matchingDependencies clear];
        [matchingDependencies addAllWithJavaUtilCollection:possibleMatchingDependencies];
        usedDeps = possibleUsedDeps;
      }
    }
  }
  
#line 209
  @try {
    id instance;
    if (bestMatchingCtor == nil) {
      instance = [((IOSClass *) nil_chk(type)) newInstance];
    }
    else {
      
#line 214
      instance = [bestMatchingCtor newInstanceWithNSObjectArray:[matchingDependencies toArray]];
    }
    if (usedDependencies != nil) {
      [usedDependencies clear];
      jint i = 0;
      for (jlong l = 1; l < usedDeps; LShiftAssignLong(&l, 1), ++i) {
        if ((usedDeps & l) > 0) {
          [usedDependencies setWithInt:i];
        }
      }
    }
    return instance;
  }
  @catch (
#line 226
  JavaLangInstantiationException *e) {
    @throw [[ComThoughtworksXstreamConvertersReflectionObjectAccessException alloc] initWithNSString:JreStrcat("$$", @"Cannot construct ", [((IOSClass *) nil_chk(type)) getName]) withJavaLangThrowable:e];
  }
  @catch (
#line 228
  JavaLangIllegalAccessException *e) {
    @throw [[ComThoughtworksXstreamConvertersReflectionObjectAccessException alloc] initWithNSString:JreStrcat("$$", @"Cannot construct ", [((IOSClass *) nil_chk(type)) getName]) withJavaLangThrowable:e];
  }
  @catch (
#line 230
  JavaLangReflectInvocationTargetException *e) {
    @throw [[ComThoughtworksXstreamConvertersReflectionObjectAccessException alloc] initWithNSString:JreStrcat("$$", @"Cannot construct ", [((IOSClass *) nil_chk(type)) getName]) withJavaLangThrowable:e];
  }
  @catch (
#line 232
  JavaLangSecurityException *e) {
    @throw [[ComThoughtworksXstreamConvertersReflectionObjectAccessException alloc] initWithNSString:JreStrcat("$$", @"Cannot construct ", [((IOSClass *) nil_chk(type)) getName]) withJavaLangThrowable:e];
  }
  @catch (
#line 234
  JavaLangExceptionInInitializerError *e) {
    @throw [[ComThoughtworksXstreamConvertersReflectionObjectAccessException alloc] initWithNSString:JreStrcat("$$", @"Cannot construct ", [((IOSClass *) nil_chk(type)) getName]) withJavaLangThrowable:e];
  }
}

- (instancetype)init {
  return [super init];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "newInstanceWithIOSClass:withNSObjectArray:", "newInstance", "Ljava.lang.Object;", 0x9, NULL },
    { "newInstanceWithIOSClass:withNSObjectArray:withJavaUtilBitSet:", "newInstance", "Ljava.lang.Object;", 0x9, NULL },
    { "init", NULL, NULL, 0x1, NULL },
  };
  static const J2ObjcClassInfo _ComThoughtworksXstreamCoreUtilDependencyInjectionFactory = { "DependencyInjectionFactory", "com.thoughtworks.xstream.core.util", NULL, 0x1, 3, methods, 0, NULL, 0, NULL};
  return &_ComThoughtworksXstreamCoreUtilDependencyInjectionFactory;
}

@end


#line 239
@implementation ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue


#line 243
- (instancetype)initWithIOSClass:(IOSClass *)type
                          withId:(id)value {
  if (self =
#line 244
  [super init]) {
    
#line 245
    self->type_ = type;
    
#line 246
    self->value_ = value;
  }
  return self;
}

- (NSString *)description {
  
#line 251
  return JreStrcat("$C@", [((IOSClass *) nil_chk(type_)) getName], ':', value_);
}

- (void)copyAllFieldsTo:(ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue *)other {
  [super copyAllFieldsTo:other];
  other->type_ = type_;
  other->value_ = value_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithIOSClass:withId:", "TypedValue", NULL, 0x1, NULL },
    { "description", "toString", "Ljava.lang.String;", 0x1, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "type_", NULL, 0x10, "Ljava.lang.Class;", NULL,  },
    { "value_", NULL, 0x10, "Ljava.lang.Object;", NULL,  },
  };
  static const J2ObjcClassInfo _ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue = { "TypedValue", "com.thoughtworks.xstream.core.util", "DependencyInjectionFactory", 0xa, 2, methods, 2, fields, 0, NULL};
  return &_ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_TypedValue;
}

@end

@implementation ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_$1


#line 80
- (jint)compareWithId:(id)o1
               withId:(id)o2 {
  
#line 81
  return ((IOSObjectArray *) nil_chk([((JavaLangReflectConstructor *) nil_chk(((JavaLangReflectConstructor *) check_class_cast(o2, [JavaLangReflectConstructor class])))) getParameterTypes]))->size_ - ((IOSObjectArray *) nil_chk(
#line 82
  [((JavaLangReflectConstructor *) nil_chk(((JavaLangReflectConstructor *) check_class_cast(o1, [JavaLangReflectConstructor class])))) getParameterTypes]))->size_;
}

- (instancetype)init {
  return [super init];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "compareWithId:withId:", "compare", "I", 0x1, NULL },
    { "init", NULL, NULL, 0x0, NULL },
  };
  static const J2ObjcClassInfo _ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_$1 = { "$1", "com.thoughtworks.xstream.core.util", "DependencyInjectionFactory", 0x8000, 2, methods, 0, NULL, 0, NULL};
  return &_ComThoughtworksXstreamCoreUtilDependencyInjectionFactory_$1;
}

@end
